<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>Pairo by Shafiullah</title>
  
  <link rel="manifest" href="manifest.json">

<link rel="apple-touch-icon" href="icon.png">

<link rel="icon" href="icon.png">

<meta name="theme-color" content="#291860">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pairo">
  
  <link rel="icon" type="image/png" href="/logo.png">
  
  <link rel="apple-touch-icon" href="/logo.png">

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    /* =============== Base / Theme (glassy) =============== */
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --bg1:#2d1b69;
      --bg2:#1a0f3d;
      --bg3:#0f0624;
      --violet:#8b5cf6;
      --violet-200:#c4b5fd;
      --violet-300:#a78bfa;
      --violet-400:#a855f7;
      --green:#22c55e;
      --red:#ef4444;
      --glass-bg: rgba(147, 51, 234, 0.08);
      --glass-brd: rgba(147, 51, 234, 0.30);
      --glass-brd-strong: rgba(147, 51, 234, 0.45);
      --glass-hover: rgba(147, 51, 234, 0.16);
    }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
    }
    .app-container{ max-width:1000px; margin:0 auto; padding:24px; }

    /* UPDATED HEADER: Reduced padding from 32px to 16px */
    .header{
      display:flex; justify-content:space-between; align-items:center;
      padding:16px 0; border-bottom:2px solid rgba(147, 51, 234, 0.3); margin-bottom:24px;
    }
    .app-title{
      font-size:25px; font-weight:800;
      background: linear-gradient(45deg, #a855f7, #c084fc);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
      display:flex; gap:12px; align-items:center;
    }
    .sets-info{
      /* background: linear-gradient(45deg, rgba(147,51,234,.2), rgba(168,85,247,.2)); */
      /* border:1px solid #a855f7; padding:12px 20px; border-radius:12px; font-size:14px; */
      font-weight:700; display:flex; gap:8px; align-items:center; backdrop-filter: blur(10px);
    }

    /* cards / buttons */
    .set-card{
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.12), rgba(168, 85, 247, 0.06));
      border:1px solid rgba(147, 51, 234, 0.35);
      border-radius:16px; padding:20px; margin-bottom:14px; position:relative;
      transition:all .3s ease; backdrop-filter: blur(10px); cursor:pointer;
      box-shadow:0 8px 24px rgba(139, 92, 246, .18);
    }
    .set-card:hover{ transform: translateY(-3px); border-color: var(--glass-brd-strong); }
    .set-name{ font-size:22px; font-weight:800; margin-bottom:70px; display:flex; gap:10px; align-items:center; }
    .set-info{ color:var(--violet-200); display:flex; gap:16px; align-items:center; font-weight:600; }

    .set-actions{
      position:absolute; right:16px; top:50%; transform:translateY(-50%);
      display:flex; gap:10px;
    }
    .action-btn{
      width:42px; height:42px; border-radius:12px; border:1px solid var(--glass-brd);
      background:linear-gradient(45deg, rgba(147,51,234,.12), rgba(147,51,234,.06));
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition:.2s ease; backdrop-filter: blur(10px); color:#fff;
    }
    .action-btn:hover{ transform: scale(1.08); border-color: var(--glass-brd-strong); }
    .edit-btn{ color: var(--green); border-color: rgba(34,197,94,.35); background:linear-gradient(45deg, rgba(34,197,94,.18), rgba(34,197,94,.08)); }
    .delete-btn{ color: var(--red); border-color: rgba(239,68,68,.35); background:linear-gradient(45deg, rgba(239,68,68,.18), rgba(239,68,68,.08)); }
    .play-btn{ color: var(--violet-200); }

    .add-btn{
      position:fixed; right:28px; bottom:28px; width:70px; height:70px; border-radius:50%;
      border:none; color:#fff; font-size:28px; cursor:pointer;
      background: linear-gradient(45deg, #8b5cf6, #a855f7);
      box-shadow:0 12px 36px rgba(139, 92, 246, .45); transition:.2s ease;
      display:flex; align-items:center; justify-content:center; z-index: 90;
    }
    .add-btn:hover{ transform: scale(1.12); }

    /* ===== NEW: Tutorial Button Style ===== */
    .tutorial-btn {
      position:fixed; right:36px; bottom:114px; width:54px; height:54px; border-radius:50%;
      border:none; color:#fff; font-size:20px; cursor:pointer;
      /* Blue/Cyan Gradient to distinguish from the purple add button */
      background: linear-gradient(45deg, #8b5cf6, #a855f7);
      box-shadow:0 8px 24px rgba(14, 165, 233, .45); transition:.2s ease;
      display:flex; align-items:center; justify-content:center; z-index: 90;
    }
    .tutorial-btn:hover{ transform: scale(1.12); }

    .empty-state{
      text-align:center; color:var(--violet-200); margin-top:64px; opacity:.85;
    }
    .empty-state i{ font-size:60px; margin-bottom:10px; display:block; }

    /* screens */
    .main-menu{ display:block; }
    .hidden{ display:none !important; }

    /* modal */
    .modal{
      display:none; position:fixed; inset:0; z-index:1000;
      background: rgba(0,0,0,.84); backdrop-filter: blur(10px);
      align-items:flex-start; justify-content:center; padding:24px;
    }
    .modal.show{ display:flex; }
    .modal-content{
      width:min(840px, 100%); margin-top:48px; border-radius:18px; padding:24px;
      background: linear-gradient(135deg, #2d1b69, #1e1b4b);
      border:1px solid rgba(147, 51, 234, .35); box-shadow:0 24px 64px rgba(139,92,246,.35);
      max-height: calc(100vh - 96px); overflow:auto;
    }
    .modal-header{
      display:flex; justify-content:space-between; align-items:center; padding-bottom:14px;
      border-bottom:1px solid rgba(147, 51, 234, .35); margin-bottom:18px;
    }
    .modal-title{ font-size:24px; font-weight:800; display:flex; gap:10px; align-items:center; }
    .close-btn{
      width:44px; height:44px; border-radius:12px; border:1px solid rgba(239,68,68,.35);
      background:linear-gradient(45deg, rgba(239,68,68,.2), rgba(239,68,68,.1));
      display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; transition:.2s;
    }
    .close-btn:hover{ transform: scale(1.05); }

    .form-section{ background: rgba(147, 51, 234, .06); border:1px solid rgba(147, 51, 234, .25); border-radius:12px; padding:16px; margin-bottom:16px; }
    .section-title{ font-size:15px; font-weight:800; color:var(--violet-300); margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; margin-bottom:8px; color:var(--violet-200); font-weight:700; font-size:14px; }
    .form-input, .form-select, .form-textarea{
      width:100%; padding:14px; border-radius:12px; border:1px solid rgba(147,51,234,.35);
      background: rgba(147,51,234,.10); color:#fff; font-size:16px; outline:none; transition:.2s ease;
    }
    .form-input::placeholder, .form-textarea::placeholder{ color:#9f8df5; }
    .form-input:focus, .form-select:focus, .form-textarea:focus{ border-color:#a855f7; box-shadow:0 0 0 3px rgba(168, 85, 247, .18); }
    .form-textarea { min-height: 150px; }

    .pairs-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .add-pair-btn{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; color:#fff;
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition:.2s ease;
    }
    .add-pair-btn:hover{ transform: translateY(-1px); box-shadow:0 6px 22px rgba(139,92,246,.32); }

    .pair-row{ display:flex; gap:10px; margin-bottom:10px; align-items:center; }
    .pair-row .form-input{ flex:1; }
    .remove-pair-btn{
      width:42px; height:42px; border-radius:12px; border:1px solid rgba(239,68,68,.35);
      background:linear-gradient(45deg, rgba(239,68,68,.22), rgba(239,68,68,.12)); color:#fff;
      display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s;
    }
    .remove-pair-btn:hover{ transform: scale(1.08); }

    .form-actions{
      display:flex; justify-content:flex-end; gap:12px; padding-top:16px;
      border-top:1px solid rgba(147, 51, 234, .35);
    }
    .btn{
      padding:14px 50px; border-radius:12px; cursor:pointer; font-size:16px; font-weight:800;
      display:flex; align-items:center; gap:8px; min-width:120px; justify-content:center; border:1px solid var(--glass-brd);
      background: linear-gradient(45deg, rgba(147,51,234,.18), rgba(147,51,234,.08)); color:#fff; transition:.2s;
    }
    .btn-primary{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; box-shadow:0 6px 22px rgba(139,92,246,.32);
    }
    .btn-block{ width:100%; margin-bottom:16px; }
    .btn:hover{ transform: translateY(-1px); }

    /* ===== Game Screen ===== */
    .game-screen{ display:none; }
    .game-header{
      display:flex; justify-content:center; align-items:center; margin-bottom:18px; padding:12px 0;
    }
    .game-title{ 
      font-size:24px; font-weight:800; display:flex; gap:10px; align-items:center; 
      text-align:center; margin:0 auto 16px auto;
    }
    .game-controls{ display:flex; gap:10px; }
    .game-btn{
      background: rgba(147,51,234,.16); border:1px solid var(--glass-brd);
      color:var(--violet-200); padding:10px 14px; border-radius:12px; cursor:pointer;
      font-size:14px; font-weight:800; display:flex; gap:8px; align-items:center; transition:.2s;
    }
    .game-btn:hover{ background: rgba(147,51,234,.24); transform: scale(1.04); }

    .progress-container{ margin:5px 0 5px; }
    .progress-label{ display:flex; justify-content:space-between; align-items:center; color:var(--violet-200); font-weight:800; font-size:13px; margin-bottom:5px; }
    .progress-bar{ height:8px; border:1px solid var(--glass-brd); border-radius:10px; background: rgba(147,51,234,.16); overflow:hidden; }
    .progress-fill{ height:100%; width:0%; background: linear-gradient(90deg, #8b5cf6, #a855f7); transition: width .35s ease; box-shadow:0 0 12px rgba(168,85,247,.45); border-radius:10px; }

    .back-btn{
      background: rgba(147,51,234,.2); border:1px solid var(--glass-brd); color:var(--violet-200);
      padding:10px 14px; border-radius:12px; cursor:pointer; margin-bottom:5px; font-weight:800; display:inline-flex; gap:8px; align-items:center; transition:.2s;
    }
    .back-btn:hover{ transform: scale(1.03); background: rgba(147,51,234,.28); }

    /* New structure for headers and content */
    .game-content-wrapper {
      margin-top: 10px;
    }
    .game-columns-headers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .column-header{
      text-align:center; font-size:16px; font-weight:800; padding:12px;
      background: linear-gradient(45deg, rgba(147,51,234,.28), rgba(168,85,247,.18));
      border-radius:12px; border:1px solid var(--glass-brd-strong);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    
    .game-columns {
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .column{ display:flex; flex-direction:column; gap:10px; }
    
    .word-card{
      background: linear-gradient(135deg, rgba(147,51,234,.12), rgba(168,85,247,.06));
      border:2px solid var(--glass-brd);
      border-radius:12px; padding:18px; text-align:center; cursor:pointer; font-size:17px; font-weight:800;
      transition:.2s ease; height:72px; display:flex; align-items:center; justify-content:center; color:#fff; backdrop-filter: blur(6px);
      user-select:none;
    }
    .word-card:hover{ background: var(--glass-hover); transform: scale(1.02); box-shadow:0 6px 22px rgba(147,51,234,.22); }
    .word-card.selected{ border-color:#a855f7; background: linear-gradient(135deg, rgba(168,85,247,.32), rgba(147,51,234,.20)); box-shadow:0 0 20px rgba(168,85,247,.38); transform: scale(1.04); }
    .word-card.matched{ border-color: var(--green); background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(34,197,94,.18)); color: var(--green); opacity:.82; cursor:default; }
    
    /* ===== NEW: Wrong Match Animation ===== */
    .word-card.wrong{ 
      border-color: var(--red) !important; 
      background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.25)) !important; 
      color: #fff !important;
      animation: shake-wrong 0.6s ease-in-out;
      box-shadow: 0 0 30px rgba(239,68,68,.6) !important;
    }

    @keyframes shake-wrong {
      0%, 100% { transform: translateX(0) scale(1.04); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) scale(1.04); }
      20%, 40%, 60%, 80% { transform: translateX(8px) scale(1.04); }
    }

    .game-complete{
      text-align:center; padding:20px; margin-top:24px;
      background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(34,197,94,.08));
      border:2px solid rgba(34,197,94,.3); border-radius:20px; backdrop-filter: blur(10px);
    }
    .game-complete img{
      width:120px; height:120px; border-radius:50%; margin-bottom:16px;
      border:4px solid rgba(34,197,94,.4); box-shadow:0 8px 32px rgba(34,197,94,.3);
    }
    .game-complete .message{
      font-size:18px; color:#fff; margin-bottom:5px; line-height:1.5;
    }
    .creator-name{
      font-size:28px; font-weight:900; margin-bottom:20px;
      background: linear-gradient(45deg, #22c55e, #10b981, #06d6a0, #22c55e);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: glow-pulse 2s ease-in-out infinite;
      text-shadow: 0 0 20px rgba(34,197,94,.5);
      filter: drop-shadow(0 0 10px rgba(34,197,94,.6));
    }
    @keyframes glow-pulse {
      0%, 100% { 
        background-position: 0% 50%;
        filter: drop-shadow(0 0 10px rgba(34,197,94,.6)) brightness(1);
      }
      50% { 
        background-position: 100% 50%;
        filter: drop-shadow(0 0 20px rgba(34,197,94,.9)) brightness(1.2);
      }
    }
    .play-again-btn{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; color:#fff;
      padding:12px 20px; border-radius:12px; font-weight:800; cursor:pointer; transition:.2s ease;
      font-size:16px; display:inline-flex; gap:8px; align-items:center;
      box-shadow:0 8px 25px rgba(34,197,94,.4);
    }
    .play-again-btn:hover{ transform: translateY(-2px); box-shadow:0 12px 35px rgba(34,197,94,.5); }

    /* New Answer View Styles */
    .answer-view {
      display: none;
      flex-direction: column;
      gap: 5px; /* Reduced gap between pairs */
    }
    .paired-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 5px; /* Reduced gap between rows */
    }

    @media(max-width:768px){
      .app-container{ padding:10px; }
      .game-columns{ gap:10px; }
      .word-card{ font-size:16px; height:60px; }
      .set-actions{ right:12px; }
      .action-btn{ width:38px; height:38px; }
      .game-btn{ padding:6px 8px; font-size:11px; gap:4px; }
      .back-btn{ padding:6px 8px; font-size:11px; gap:4px; }
      .game-controls{ gap:6px; }
      
      /* Mobile shake animation - less aggressive */
      @keyframes shake-wrong {
        0%, 100% { transform: translateX(0) scale(1.02); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) scale(1.02); }
        20%, 40%, 60%, 80% { transform: translateX(5px) scale(1.02); }
      }
    }

    /* toast */
    .toast{
      position:fixed; right:18px; top:18px; z-index:1100; padding:12px 14px;
      background: rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.18); border-radius:12px; color:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; transform: translateY(-8px); transition:.25s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-menu" id="mainMenu">
      <div class="header">
        <h6 class="app-title"><i class="fas fa-language"></i>Pairo</h6>
        <div class="sets-info" id="setsCount"><i class="fas fa-book"></i> 0 Sets</div>
      </div>

      <div id="setsList"></div>

      <div class="empty-state" id="emptyState" style="display:none;">
        <i class="fas fa-box-open"></i>
        Click the + button to create your first set.
      </div>
      
      <!-- NEW: Tutorial Button (Play Icon) stacked above the Add button -->
      <button class="tutorial-btn" id="tutorialBtn" title="How to Play"><i class="fas fa-play"></i></button>

      <button class="add-btn" id="mainAddBtn" title="Create Set"><i class="fas fa-plus"></i></button>
    </div>

    <div class="game-screen" id="gameScreen">
      <h2 class="game-title" id="gameTitle"><i class="fas fa-gamepad"></i> Game</h2>
      
      <div class="game-header">
        <div class="game-controls">
          <!-- Back button now triggers history.back() via JS -->
          <button class="game-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
          <button class="game-btn" id="soundBtn"><i class="fas fa-volume-up"></i> Sound</button>
          <button class="game-btn" id="speechBtn"><i class="fas fa-microphone"></i> Speech</button>
          <button class="game-btn" id="shuffleBtn"><i class="fas fa-random"></i> Shuffle</button>
          <button class="game-btn" id="answerBtn"><i class="fas fa-eye"></i> Answer</button>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-label">
          <span>Progress</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      
      <div class="game-content-wrapper">
        <div class="game-columns-headers">
          <div class="column-header"><i class="fas fa-language"></i> English </div>
          <div class="column-header"><i class="fas fa-globe"></i> Others </div>
        </div>

        <div class="game-columns" id="game-columns">
          <div class="column" id="leftCol"></div>
          <div class="column" id="rightCol"></div>
        </div>

        <div class="answer-view" id="answer-view"></div>
      </div>

      <div id="gameComplete" class="game-complete" style="display:none;">
        <a href="https://ibb.co.com/V0fzGC0c"><img src="https://i.ibb.co.com/XfcKP5fr/Shafiullah-AI-avatar.png" alt="Shafiullah-AI-avatar" border="0"></a>
        <div class="message">Congratulations! You got everything correct. Here's a big thanks from<div class="creator-name">Shafiullah! <h1><i class="fas fa-trophy"></i> </div>
        <button class="play-again-btn" id="playAgainBtn"><i class="fas fa-play"></i> Play Again</button>
      </div>
    </div>
  </div>

  <div class="modal" id="chooseOptionModal" aria-hidden="true">
    <div class="modal-content" style="width: min(500px, 90%); margin-top: 20vh; max-height: unset; overflow: unset;">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-cogs"></i> Choose Option</div>
        <button class="close-btn" id="closeChooseOptionModalBtn" title="Close"><i class="fas fa-times"></i></button>
      </div>
      <div class="form-actions" style="border:none; padding-top:0; flex-direction: column;">
        <button class="btn btn-primary btn-block" id="createSetBtn"><i class="fas fa-pen"></i> Create Set</button>
        <button class="btn btn-primary btn-block" id="pasteJsonBtn"><i class="fas fa-file-import"></i> Create with AI</button>
      </div>
    </div>
  </div>

  <div class="modal" id="pasteJsonModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-file-import"></i> Paste JSON</div>
        <button class="close-btn" id="closePasteJsonModalBtn" title="Close"><i class="fas fa-times"></i></button>
      </div>
      <p style="margin-bottom: 16px; line-height: 1.5; color: var(--violet-200);">Copy→Generate→Paste→Load</p>
      <div class="form-actions" style="justify-content: flex-start; border: none; padding-top: 0;">
        <button class="btn btn-primary" id="copyAiPromptBtn"><i class="fas fa-copy"></i> Copy AI Prompt</button>
      </div>
      <div class="form-group" style="margin-top: 16px;">
        <label class="form-label"></label>
        <textarea id="jsonInput"class="form-textarea" placeholder="Paste your AI generated JSON text here..."></textarea>
      </div>
      <div class="form-actions">
        <button class="btn" id="cancelJsonBtn"><i class="fas fa-ban"></i> Cancel</button>
        <button class="btn btn-primary" id="loadJsonBtn"><i class="fas fa-upload"></i> Load JSON</button>
      </div>
    </div>
  </div>

  <div class="modal" id="setModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="setModalTitle"><i class="fas fa-layer-group"></i> Create Set</div>
        <button class="close-btn" id="closeSetModalBtn" title="Close"><i class="fas fa-times"></i></button>
      </div>

      <div class="form-section">
        <div class="section-title"><i class="fas fa-pen"></i> Details</div>
        <div class="form-group">
          <label class="form-label" for="setNameInput">Set Name</label>
          <input id="setNameInput" class="form-input" placeholder="e.g., Basic Japanese" />
        </div>
        <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label class="form-label" for="categorySelect">Category</label>
            <select id="categorySelect" class="form-select">
              <option>General</option>
           </select>
          </div>
          <div>
            <label class="form-label" for="difficultySelect">Difficulty</label>
            <select id="difficultySelect" class="form-select">
              <option>Beginner</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="pairs-header">
          <div class="section-title"><i class="fas fa-link"></i> Word Pairs</div>
        </div>
        <div id="pairsContainer"></div>
        <button class="add-pair-btn" id="addPairBtn"><i class="fas fa-plus"></i> Add Pair</button>
      </div>

      <div class="form-actions">
        <button class="btn" id="cancelSetBtn"><i class="fas fa-ban"></i> Cancel</button>
        <button class="btn btn-primary" id="saveSetBtn"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- NEW: Tutorial Modal -->
  <div class="modal" id="tutorialModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-video"></i> How to Play</div>
        <button class="close-btn" id="closeTutorialModalBtn" title="Close"><i class="fas fa-times"></i></button>
      </div>
      <!-- Wrapper to limit video size on large screens, video injected by JS -->
      <div id="tutorialVideoContainer" style="max-width: 500px; margin: 0 auto;"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ====================== State ======================
    const LS_KEY = "wordPairMasterSets";
    let sets = [];
    let editingIndex = -1;

    // game state
    let currentSetIndex = -1;
    let firstSelection = null; // {el, pairId, lang}
    let secondSelection = null;
    let lockBoard = false;
    let pairsFound = 0;
    let matchedPairIds = new Set();
    let soundOn = true;
    let speechOn = true;
    let answersVisible = false;

    // ====================== Elements ======================
    const mainMenu = document.getElementById("mainMenu");
    const setsList = document.getElementById("setsList");
    const setsCount = document.getElementById("setsCount");
    const emptyState = document.getElementById("emptyState");
    const mainAddBtn = document.getElementById("mainAddBtn");

    const gameScreen = document.getElementById("gameScreen");
    const gameTitle = document.getElementById("gameTitle");
    const backBtn = document.getElementById("backBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const soundBtn = document.getElementById("soundBtn");
    const speechBtn = document.getElementById("speechBtn");
    const answerBtn = document.getElementById("answerBtn");
    const gameColumns = document.getElementById("game-columns"); // Now this only contains the word cards
    const leftCol = document.getElementById("leftCol");
    const rightCol = document.getElementById("rightCol");
    const answerView = document.getElementById("answer-view");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const gameComplete = document.getElementById("gameComplete");
    const playAgainBtn = document.getElementById("playAgainBtn");

    const setModal = document.getElementById("setModal");
    const setModalTitle = document.getElementById("setModalTitle");
    const closeSetModalBtn = document.getElementById("closeSetModalBtn");
    const setNameInput = document.getElementById("setNameInput");
    const categorySelect = document.getElementById("categorySelect");
    const difficultySelect = document.getElementById("difficultySelect");
    const pairsContainer = document.getElementById("pairsContainer");
    const addPairBtn = document.getElementById("addPairBtn");
    const cancelSetBtn = document.getElementById("cancelSetBtn");
    const saveSetBtn = document.getElementById("saveSetBtn");

    const chooseOptionModal = document.getElementById("chooseOptionModal");
    const closeChooseOptionModalBtn = document.getElementById("closeChooseOptionModalBtn");
    const createSetBtn = document.getElementById("createSetBtn");
    const pasteJsonBtn = document.getElementById("pasteJsonBtn");

    const pasteJsonModal = document.getElementById("pasteJsonModal");
    const closePasteJsonModalBtn = document.getElementById("closePasteJsonModalBtn");
    const copyAiPromptBtn = document.getElementById("copyAiPromptBtn");
    const jsonInput = document.getElementById("jsonInput");
    const cancelJsonBtn = document.getElementById("cancelJsonBtn");
    const loadJsonBtn = document.getElementById("loadJsonBtn");

    // NEW: Elements for Tutorial
    const tutorialBtn = document.getElementById("tutorialBtn");
    const tutorialModal = document.getElementById("tutorialModal");
    const closeTutorialModalBtn = document.getElementById("closeTutorialModalBtn");
    const tutorialVideoContainer = document.getElementById("tutorialVideoContainer");
    const tutorialEmbedCode = '<div style="position:relative; width:100%; height:0px; padding-bottom:100.000%"><iframe allow="fullscreen;autoplay" allowfullscreen height="100%" src="https://streamable.com/e/0rqsaa?autoplay=1" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; overflow:hidden;"></iframe></div>';

    const toastEl = document.getElementById("toast");

    // ====================== History API / Back Button Logic ======================
    // 1. Initialize History: Ensure the first page is explicitly 'home'
    window.addEventListener('load', () => {
      // Use replaceState to set the initial state without creating a new history entry
      history.replaceState({ page: 'home' }, '', window.location.pathname);
    });

    // 2. Central Popstate Listener: Handles Back (Hardware & UI) and Forward buttons
    window.addEventListener('popstate', (event) => {
      const state = event.state || { page: 'home' };

      // Always close any open modals first when history changes (Back pressed in modal)
      // This is the "logic" counterpart to history.back()
      _applyModalClose();

      if (state.page === 'home') {
        // Show Menu, Hide Game
        gameScreen.style.display = 'none';
        mainMenu.style.display = 'block';
        // Refresh sets in case of updates
        renderSets(); 
      } 
      else if (state.page === 'game') {
        // Show Game, Hide Menu (supports Forward button navigation)
        mainMenu.style.display = 'none';
        gameScreen.style.display = 'block';
      }
      // If state.page === 'modal', the actual modal opening is usually handled by the
      // forward action reusing the existing DOM. However, for modals, we generally
      // don't need complex restoration logic as they are transient.
    });

    // 3. Navigation Wrappers
    
    // Call this when opening a modal
    function openModal(modalEl){ 
      // Push modal state to history
      history.pushState({ page: 'modal', modalId: modalEl.id }, '', '');
      modalEl.classList.add("show"); 
      modalEl.setAttribute("aria-hidden","false"); 
    }

    // Call this to close a modal (via UI Buttons)
    function closeModal(modalEl){ 
      // Instead of removing the class directly, we go back in history.
      // This triggers 'popstate', which calls _applyModalClose().
      // This ensures hardware back button and UI buttons behave identically.
      history.back();
    }

    // Internal function called by popstate to actually hide modals DOM
    function _applyModalClose(){
      document.querySelectorAll('.modal.show').forEach(el => {
        // UPDATED: If closing the tutorial modal, clear the video container to stop audio
        if(el.id === "tutorialModal") {
           tutorialVideoContainer.innerHTML = "";
        }
        el.classList.remove("show");
        el.setAttribute("aria-hidden", "true");
      });
    }

    // ====================== Utils ======================
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 1600);
    }
    function loadSets(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        sets = raw ? JSON.parse(raw) : [];
      }catch(e){
        console.warn("Failed to load sets", e);
        sets = [];
      }
    }
    function saveSets(){
      localStorage.setItem(LS_KEY, JSON.stringify(sets));
    }
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ====================== NEW: Vibration Function ======================
    function triggerVibration(){
      if ('vibrate' in navigator) {
        navigator.vibrate([100, 50, 100, 50, 150]);
      }
    }

    // ====================== Sets UI ======================
    function renderSets(){
      setsList.innerHTML = "";
      if(sets.length === 0){
        emptyState.style.display = "block";
      }else{
        emptyState.style.display = "none";
        sets.forEach((set, index)=>{
          const card = document.createElement("div");
          card.className = "set-card";
          card.innerHTML = `
            <div class="set-name"><i class="fas fa-layer-group"></i> ${escapeHtml(set.name)}</div>
            <div class="set-info">
              <div class="set-info-item"><i class="fas fa-link"></i> ${set.pairs.length} pairs</div>
              <div class="set-info-item"><i class="fas fa-tag"></i> ${escapeHtml(set.category || "General")}</div>
              <div class="set-info-item"><i class="fas fa-signal"></i> ${escapeHtml(set.difficulty || "Beginner")}</div>
            </div>
            <div class="set-actions">
              <button class="action-btn play-btn" title="Play" data-action="play" data-index="${index}">
                <i class="fas fa-play"></i>
              </button>
              <button class="action-btn edit-btn" title="Edit" data-action="edit" data-index="${index}">
                <i class="fas fa-pen"></i>
              </button>
              <button class="action-btn delete-btn" title="Delete" data-action="delete" data-index="${index}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          card.addEventListener("click",(e)=>{
            const actBtn = e.target.closest(".action-btn");
            if(actBtn) return;
            startGame(index);
          });
          card.querySelectorAll(".action-btn").forEach(btn=>{
            btn.addEventListener("click",(e)=>{
              e.stopPropagation();
              const idx = +btn.dataset.index;
              const action = btn.dataset.action;
              if(action === "play") startGame(idx);
              else if(action === "edit") openEditSet(idx);
              else if(action === "delete") { deleteSet(idx); }
            });
          });

          setsList.appendChild(card);
        });
      }
      setsCount.innerHTML = `<i class="fas fa-book"></i> ${sets.length} Set${sets.length!==1?"s":""}`;
    }

    function deleteSet(index){
      if(!confirm("Delete this set?")) return;
      sets.splice(index,1);
      saveSets();
      renderSets();
      showToast("Set deleted");
    }

    // ====================== Create / Edit Modal ======================
    function openCreateSet(){
      editingIndex = -1;
      setModalTitle.innerHTML = `<i class="fas fa-layer-group"></i> Create Set`;
      setNameInput.value = "";
      categorySelect.value = "General";
      difficultySelect.value = "Beginner";
      pairsContainer.innerHTML = "";
      addPairRow();
      openModal(setModal);
    }

    function openEditSet(index){
      editingIndex = index;
      const set = sets[index];
      setModalTitle.innerHTML = `<i class="fas fa-pen"></i> Edit Set`;
      setNameInput.value = set.name || "";
      categorySelect.value = set.category || "General";
      difficultySelect.value = set.difficulty || "Beginner";
      pairsContainer.innerHTML = "";
      (set.pairs || []).forEach(p => addPairRow(p.word1, p.word2));
      if((set.pairs || []).length === 0) addPairRow();
      openModal(setModal);
    }

    function addPairRow(w1="", w2=""){
      const row = document.createElement("div");
      row.className = "pair-row";
      row.innerHTML = `
        <input class="form-input" placeholder="English" value="${escapeAttr(w1)}" />
        <input class="form-input" placeholder="Other language" value="${escapeAttr(w2)}" />
        <button class="remove-pair-btn" title="Remove"><i class="fas fa-times"></i></button>
      `;
      row.querySelector(".remove-pair-btn").addEventListener("click", ()=> {
        row.remove();
      });
      pairsContainer.appendChild(row);
    }

    function gatherPairs(){
      const rows = Array.from(pairsContainer.querySelectorAll(".pair-row"));
      const pairs = rows.map(r=>{
        const [i1, i2] = r.querySelectorAll("input");
        return { word1: (i1.value||"").trim(), word2: (i2.value||"").trim() };
      }).filter(p=> p.word1 && p.word2);
      return pairs;
    }

    function saveSet(){
      const name = setNameInput.value.trim();
      const category = categorySelect.value;
      const difficulty = difficultySelect.value;
      const pairs = gatherPairs();

      if(!name || pairs.length===0){
        showToast("Please enter a set name and at least one valid pair.");
        return;
      }

      if(editingIndex === -1){
        sets.push({ name, category, difficulty, pairs });
        showToast("Set created");
      }else{
        sets[editingIndex] = { name, category, difficulty, pairs };
        showToast("Set updated");
      }
      saveSets();
      renderSets();
      closeModal(setModal); // Triggers history.back()
    }
    
    // ====================== JSON Import Logic ======================
    function loadJsonSet(){
      try{
        const jsonText = jsonInput.value.trim();
        if(!jsonText){
          showToast("Please paste JSON data first.");
          return;
        }
        const newSets = JSON.parse(jsonText);
        if(!Array.isArray(newSets)){
          showToast("Invalid JSON format. Expected an array.");
          return;
        }
        
        sets.push(...newSets);
        saveSets();
        renderSets();
        closeModal(pasteJsonModal); // Triggers history.back()
        showToast("Sets loaded successfully!");

      } catch(e) {
        showToast("Failed to load JSON. Please check the format.");
        console.error("JSON parse error:", e);
      }
    }

    // ====================== Game Logic ======================
    function startGame(index){
      // Push 'game' state to history
      history.pushState({ page: 'game', index: index }, '', '#game');
      // Then execute UI Logic
      _startGameUI(index);
    }

    // Internal function to update DOM for game (separated from history logic)
    function _startGameUI(index) {
      currentSetIndex = index;
      const set = sets[index];
      if(!set || !set.pairs || set.pairs.length===0){
        showToast("This set has no pairs.");
        return;
      }
      // reset state
      firstSelection = null;
      secondSelection = null;
      lockBoard = false;
      matchedPairIds = new Set();
      pairsFound = 0;
      answersVisible = false;

      // UI
      mainMenu.style.display = "none";
      gameScreen.style.display = "block";
      gameTitle.innerHTML = `<i class="fas fa-gamepad"></i> ${escapeHtml(set.name)}`;
      gameComplete.style.display = "none";
      answerBtn.innerHTML = `<i class="fas fa-eye"></i> Answer`;
      
      gameColumns.style.display = "grid";
      answerView.style.display = "none";
      
      renderGameColumns();
      updateProgress();
    }

    function renderGameColumns(){
      const set = sets[currentSetIndex];
      const englishWords = set.pairs.map((pair, i)=> ({ text: pair.word1, pairId: i, lang: "en" }));
      const otherWords   = set.pairs.map((pair, i)=> ({ text: pair.word2, pairId: i, lang: "other" }));

      shuffleArray(englishWords);
      shuffleArray(otherWords);

      leftCol.innerHTML = "";
      rightCol.innerHTML = "";

      englishWords.forEach(data=> leftCol.appendChild(createWordCard(data)));
      otherWords.forEach(data=> rightCol.appendChild(createWordCard(data)));
    }

    function createWordCard({text, pairId, lang}){
      const div = document.createElement("div");
      div.className = "word-card";
      div.textContent = text;
      div.dataset.pairId = String(pairId);
      div.dataset.lang = lang;
      
      if(matchedPairIds.has(String(pairId))){
        div.classList.add("matched");
        div.style.pointerEvents = "none";
      }else{
        div.addEventListener("click", handleCardClick);
      }
      return div;
    }

    function handleCardClick(e){
      if(lockBoard || answersVisible) return;
      const el = e.currentTarget;
      if(el.classList.contains("matched")) return;

      if(speechOn){
        speakText(el.textContent, el.dataset.lang);
      }

      // select
      if(firstSelection && el === firstSelection.el) return; // click same
      el.classList.add("selected");

      if(!firstSelection){
        firstSelection = {
          el,
          pairId: el.dataset.pairId,
          lang: el.dataset.lang
        };
        playClick();
      }else{
        secondSelection = {
          el,
          pairId: el.dataset.pairId,
          lang: el.dataset.lang
        };

        if(firstSelection.lang === secondSelection.lang){
          firstSelection.el.classList.remove("selected");
          firstSelection = { ...secondSelection };
          secondSelection = null;
          playClick();
          return;
        }

        lockBoard = true;
        if(firstSelection.pairId === secondSelection.pairId){
          setTimeout(()=>{
            firstSelection.el.classList.remove("selected");
            secondSelection.el.classList.remove("selected");
            firstSelection.el.classList.add("matched");
            secondSelection.el.classList.add("matched");
            firstSelection.el.style.pointerEvents = "none";
            secondSelection.el.style.pointerEvents = "none";

            matchedPairIds.add(firstSelection.pairId);
            pairsFound++;
            playSuccess();

            resetPick();
            lockBoard = false;
            updateProgress();
            checkCompletion();
          }, 220);
        }else{
          playError();
          triggerVibration();
          
          firstSelection.el.classList.add("wrong");
          secondSelection.el.classList.add("wrong");
          
          setTimeout(()=>{
            firstSelection.el.classList.remove("selected","wrong");
            secondSelection.el.classList.remove("selected","wrong");
            resetPick();
            lockBoard = false;
          }, 650);
        }
      }
    }

    function resetPick(){
      firstSelection = null;
      secondSelection = null;
    }

    function updateProgress(){
      const total = sets[currentSetIndex].pairs.length;
      const pct = Math.round((pairsFound/total)*100);
      progressFill.style.width = pct + "%";
      progressText.textContent = pct + "%";
    }

    function checkCompletion(){
      const total = sets[currentSetIndex].pairs.length;
      if(pairsFound >= total){
        setTimeout(() => {
          gameComplete.style.display = "block";
        }, 500);
      }
    }

    // OLD backToMenu removed/replaced by history.back() logic
    // The visual part is handled in popstate event

    function reshuffleGame(){
      if(answersVisible) {
        hideAnswers();
      }
      if(sets[currentSetIndex]?.pairs?.length){
        const total = sets[currentSetIndex].pairs.length;
        const isGameComplete = pairsFound >= total;
        
        firstSelection = null;
        secondSelection = null;
        lockBoard = false;
        
        if(isGameComplete) {
          matchedPairIds = new Set();
          pairsFound = 0;
          updateProgress();
          gameComplete.style.display = "none";
          showToast("Game restarted!");
        } else {
          showToast("Shuffled");
        }
        
        renderGameColumns();
      }
    }
    
    // ====================== Answer Toggle Logic ======================
    function toggleAnswers() {
      if (answersVisible) {
        hideAnswers();
      } else {
        showAnswers();
      }
    }

    function showAnswers() {
      if(lockBoard) return;
      answersVisible = true;
      showToast("Answers revealed");
      gameColumns.style.display = "none";
      answerView.style.display = "flex";
      answerBtn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide`;
      if (firstSelection) {
        firstSelection.el.classList.remove("selected");
        resetPick();
      }
      renderAnswerPairs();
    }
    
    function hideAnswers() {
      answersVisible = false;
      showToast("Answers hidden");
      answerView.style.display = "none";
      gameColumns.style.display = "grid";
      answerBtn.innerHTML = `<i class="fas fa-eye"></i> Answer`;
      renderGameColumns();
    }
    
    function renderAnswerPairs() {
      answerView.innerHTML = "";
      const set = sets[currentSetIndex];
      set.pairs.forEach(pair => {
          const row = document.createElement("div");
          row.className = "paired-row";
          const englishCard = createWordCard({
            text: pair.word1, pairId: -1, lang: "en"
          });
          englishCard.classList.add("matched");
          englishCard.style.pointerEvents = "none";
          const otherCard = createWordCard({
            text: pair.word2, pairId: -1, lang: "other"
          });
          otherCard.classList.add("matched");
          otherCard.style.pointerEvents = "none";
          row.appendChild(englishCard);
          row.appendChild(otherCard);
          answerView.appendChild(row);
      });
    }

    // ====================== Text-to-Speech ======================
    function speakText(text, lang) {
      if (!speechOn || !window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      let textToSpeak = text;
      if (lang === "other" && text.includes(":")) {
        textToSpeak = text.split(":")[0].trim();
      }
      const utterance = new SpeechSynthesisUtterance(textToSpeak);
      if (lang === "other") {
        utterance.lang = "ja-JP";
        utterance.rate = 0.8;
      } else {
        utterance.lang = "en-GB";
        utterance.rate = 0.9;
      }
      utterance.volume = 0.7;
      utterance.pitch = 1.0;
      
      const voices = window.speechSynthesis.getVoices();
      if (lang === "other") {
        const japaneseVoice = voices.find(voice => 
          voice.lang.startsWith('ja') || voice.name.includes('Japanese')
        );
        if (japaneseVoice) utterance.voice = japaneseVoice;
      } else {
        const englishVoice = voices.find(voice => 
          voice.lang.startsWith('en') && voice.default
        );
        if (englishVoice) utterance.voice = englishVoice;
      }
      window.speechSynthesis.speak(utterance);
    }

    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {};
    }

    // ====================== Sound Effects ======================
    function playTone(freq=880, ms=120, type="sine", gain=0.05){
      if(!soundOn) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        g.gain.value = gain;
        osc.connect(g); g.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
      }catch(_){}
    }
    function playSuccess(){ playTone(980, 120, "triangle", 0.06); }
    function playError(){ playTone(220, 160, "sawtooth", 0.06); }
    function playClick(){ playTone(660, 80, "square", 0.04); }

    // ====================== Events ======================
    mainAddBtn.addEventListener("click", () => openModal(chooseOptionModal));
    
    // UPDATED: Close buttons now trigger history.back()
    closeSetModalBtn.addEventListener("click", () => closeModal(setModal));
    cancelSetBtn.addEventListener("click", () => closeModal(setModal));
    
    addPairBtn.addEventListener("click", ()=> addPairRow());
    saveSetBtn.addEventListener("click", saveSet);
    
    closeChooseOptionModalBtn.addEventListener("click", () => closeModal(chooseOptionModal));
    createSetBtn.addEventListener("click", () => {
        // We close the current modal by going back, then open the new one
        // Note: history.back is async, but openCreateSet is synchronous UI update?
        // Actually, better UX: replaceState or just standard flow.
        // Simple flow: Go back (close options), then open Create.
        history.back(); // close ChooseOption
        setTimeout(() => openCreateSet(), 50); // Small delay to allow popstate to finish
    });
    pasteJsonBtn.addEventListener("click", () => {
        history.back(); // close ChooseOption
        setTimeout(() => openModal(pasteJsonModal), 50);
    });
    
    closePasteJsonModalBtn.addEventListener("click", () => closeModal(pasteJsonModal));
    cancelJsonBtn.addEventListener("click", () => closeModal(pasteJsonModal));
    loadJsonBtn.addEventListener("click", loadJsonSet);
    
    // NEW: Tutorial Events
    tutorialBtn.addEventListener("click", () => {
       // Insert iframe code when opening
       tutorialVideoContainer.innerHTML = tutorialEmbedCode;
       openModal(tutorialModal);
    });
    closeTutorialModalBtn.addEventListener("click", () => closeModal(tutorialModal));

    copyAiPromptBtn.addEventListener("click", async () => {
      const prompt = `Prompt:

Please generate a set of the most useful and common polite word pairs for Japanese language learning in JSON format. Include just the words, without any praise or sentences. It is not necessary to specify which word is polite. Provide the Japanese words in both kanji and hiragana. For example, write "食べます : たべます." If a word does not have kanji, use either hiragana or katakana, as appropriate.

The JSON should be an array of objects. Each object must represent a single set and follow this exact structure:

[
  {
    "name": "Set Name",
    "category": "Category",
    "difficulty": "Difficulty",
    "pairs": [
      {
        "word1": "English Word",
        "word2": "Translated Word"
      }
    ]
  }
]

Example Output:

[
  {
    "name": "Daily Life Verbs",
    "category": "Verbs",
    "difficulty": "Beginner",
    "pairs": [
      {
        "word1": "to eat",
        "word2": "食べます : たべます"
      },
      {
        "word1": "to drink",
        "word2": "飲みます : のみます"
      },
      {
        "word1": "to do / make",
        "word2": "します"
      }
    ]
  }
]

Please generate a single JSON array with 1–5 example sets.
Keep words simple, natural, and clear for learners.
Output only valid JSON, no extra explanations.`;
      try {
        await navigator.clipboard.writeText(prompt);
        showToast("Prompt copied!");
      } catch (err) {
        showToast("Failed to copy prompt.");
      }
    });

    // UPDATED: Back button in game triggers history.back()
    backBtn.addEventListener("click", () => history.back());
    
    shuffleBtn.addEventListener("click", reshuffleGame);
    soundBtn.addEventListener("click", ()=>{
      soundOn = !soundOn;
      soundBtn.innerHTML = soundOn
        ? `<i class="fas fa-volume-up"></i> Sound`
        : `<i class="fas fa-volume-xmark"></i> Sound Off`;
      showToast(soundOn ? "Game sounds on" : "Game sounds off");
    });
    
    speechBtn.addEventListener("click", ()=>{
      speechOn = !speechOn;
      speechBtn.innerHTML = speechOn
        ? `<i class="fas fa-microphone"></i> Speech`
        : `<i class="fas fa-microphone-slash"></i> Speech Off`;
      showToast(speechOn ? "Text-to-speech on" : "Text-to-speech off");
    });

    answerBtn.addEventListener("click", toggleAnswers);

    playAgainBtn.addEventListener("click", ()=>{
      matchedPairIds = new Set();
      pairsFound = 0;
      firstSelection = null;
      secondSelection = null;
      lockBoard = false;
      gameComplete.style.display = "none";
      updateProgress();
      renderGameColumns();
      showToast("Let's play again!");
    });

    function escapeHtml(str=""){
      return str.replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
    }
    function escapeAttr(str=""){ return escapeHtml(str).replace(/"/g, "&quot;"); }

    (function init(){
      loadSets();
      renderSets();
    })();
  </script>
</body>
</html>