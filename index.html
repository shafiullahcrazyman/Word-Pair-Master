<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>Word Pair Master by Shafiullah</title>
  
  <link rel="icon" type="image/png" href="/logo.png">
  
  <link rel="apple-touch-icon" href="/logo.png">

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    /* =============== Base / Theme (glassy) =============== */
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --bg1:#2d1b69;
      --bg2:#1a0f3d;
      --bg3:#0f0624;
      --violet:#8b5cf6;
      --violet-200:#c4b5fd;
      --violet-300:#a78bfa;
      --violet-400:#a855f7;
      --green:#22c55e;
      --red:#ef4444;
      --glass-bg: rgba(147, 51, 234, 0.08);
      --glass-brd: rgba(147, 51, 234, 0.30);
      --glass-brd-strong: rgba(147, 51, 234, 0.45);
      --glass-hover: rgba(147, 51, 234, 0.16);
    }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
    }
    .app-container{ max-width:1000px; margin:0 auto; padding:24px; }

    .header{
      display:flex; justify-content:space-between; align-items:center;
      padding:32px 0; border-bottom:2px solid rgba(147, 51, 234, 0.3); margin-bottom:24px;
    }
    .app-title{
      font-size:32px; font-weight:800;
      background: linear-gradient(45deg, #a855f7, #c084fc);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
      display:flex; gap:12px; align-items:center;
    }
    .sets-info{
      background: linear-gradient(45deg, rgba(147,51,234,.2), rgba(168,85,247,.2));
      border:1px solid #a855f7; padding:12px 20px; border-radius:12px; font-size:14px;
      font-weight:700; display:flex; gap:8px; align-items:center; backdrop-filter: blur(10px);
    }

    /* cards / buttons */
    .set-card{
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.12), rgba(168, 85, 247, 0.06));
      border:1px solid rgba(147, 51, 234, 0.35);
      border-radius:16px; padding:20px; margin-bottom:14px; position:relative;
      transition:all .3s ease; backdrop-filter: blur(10px); cursor:pointer;
      box-shadow:0 8px 24px rgba(139, 92, 246, .18);
    }
    .set-card:hover{ transform: translateY(-3px); border-color: var(--glass-brd-strong); }
    .set-name{ font-size:22px; font-weight:800; margin-bottom:70px; display:flex; gap:10px; align-items:center; }
    .set-info{ color:var(--violet-200); display:flex; gap:16px; align-items:center; font-weight:600; }

    .set-actions{
      position:absolute; right:16px; top:50%; transform:translateY(-50%);
      display:flex; gap:10px;
    }
    .action-btn{
      width:42px; height:42px; border-radius:12px; border:1px solid var(--glass-brd);
      background:linear-gradient(45deg, rgba(147,51,234,.12), rgba(147,51,234,.06));
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition:.2s ease; backdrop-filter: blur(10px); color:#fff;
    }
    .action-btn:hover{ transform: scale(1.08); border-color: var(--glass-brd-strong); }
    .edit-btn{ color: var(--green); border-color: rgba(34,197,94,.35); background:linear-gradient(45deg, rgba(34,197,94,.18), rgba(34,197,94,.08)); }
    .delete-btn{ color: var(--red); border-color: rgba(239,68,68,.35); background:linear-gradient(45deg, rgba(239,68,68,.18), rgba(239,68,68,.08)); }
    .play-btn{ color: var(--violet-200); }

    .add-btn{
      position:fixed; right:28px; bottom:28px; width:70px; height:70px; border-radius:50%;
      border:none; color:#fff; font-size:28px; cursor:pointer;
      background: linear-gradient(45deg, #8b5cf6, #a855f7);
      box-shadow:0 12px 36px rgba(139, 92, 246, .45); transition:.2s ease;
      display:flex; align-items:center; justify-content:center;
    }
    .add-btn:hover{ transform: scale(1.12); }

    .empty-state{
      text-align:center; color:var(--violet-200); margin-top:64px; opacity:.85;
    }
    .empty-state i{ font-size:60px; margin-bottom:10px; display:block; }

    /* screens */
    .main-menu{ display:block; }
    .hidden{ display:none !important; }

    /* modal */
    .modal{
      display:none; position:fixed; inset:0; z-index:1000;
      background: rgba(0,0,0,.84); backdrop-filter: blur(10px);
      align-items:flex-start; justify-content:center; padding:24px;
    }
    .modal.show{ display:flex; }
    .modal-content{
      width:min(840px, 100%); margin-top:48px; border-radius:18px; padding:24px;
      background: linear-gradient(135deg, #2d1b69, #1e1b4b);
      border:1px solid rgba(147, 51, 234, .35); box-shadow:0 24px 64px rgba(139,92,246,.35);
      max-height: calc(100vh - 96px); overflow:auto;
    }
    .modal-header{
      display:flex; justify-content:space-between; align-items:center; padding-bottom:14px;
      border-bottom:1px solid rgba(147, 51, 234, .35); margin-bottom:18px;
    }
    .modal-title{ font-size:24px; font-weight:800; display:flex; gap:10px; align-items:center; }
    .close-btn{
      width:44px; height:44px; border-radius:12px; border:1px solid rgba(239,68,68,.35);
      background:linear-gradient(45deg, rgba(239,68,68,.2), rgba(239,68,68,.1));
      display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; transition:.2s;
    }
    .close-btn:hover{ transform: scale(1.05); }

    .form-section{ background: rgba(147, 51, 234, .06); border:1px solid rgba(147, 51, 234, .25); border-radius:12px; padding:16px; margin-bottom:16px; }
    .section-title{ font-size:15px; font-weight:800; color:var(--violet-300); margin-bottom:12px; display:flex; gap:8px; align-items:center; }
    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; margin-bottom:8px; color:var(--violet-200); font-weight:700; font-size:14px; }
    .form-input, .form-select{
      width:100%; padding:14px; border-radius:12px; border:1px solid rgba(147,51,234,.35);
      background: rgba(147,51,234,.10); color:#fff; font-size:16px; outline:none; transition:.2s ease;
    }
    .form-input::placeholder{ color:#9f8df5; }
    .form-input:focus, .form-select:focus{ border-color:#a855f7; box-shadow:0 0 0 3px rgba(168, 85, 247, .18); }

    .pairs-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .add-pair-btn{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; color:#fff;
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition:.2s ease;
    }
    .add-pair-btn:hover{ transform: translateY(-1px); box-shadow:0 6px 22px rgba(139,92,246,.32); }

    .pair-row{ display:flex; gap:10px; margin-bottom:10px; align-items:center; }
    .pair-row .form-input{ flex:1; }
    .remove-pair-btn{
      width:42px; height:42px; border-radius:12px; border:1px solid rgba(239,68,68,.35);
      background:linear-gradient(45deg, rgba(239,68,68,.22), rgba(239,68,68,.12)); color:#fff;
      display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s;
    }
    .remove-pair-btn:hover{ transform: scale(1.08); }

    .form-actions{
      display:flex; justify-content:flex-end; gap:12px; padding-top:16px;
      border-top:1px solid rgba(147, 51, 234, .35);
    }
    .btn{
      padding:14px 10px; border-radius:12px; cursor:pointer; font-size:16px; font-weight:800;
      display:flex; align-items:center; gap:8px; min-width:120px; justify-content:center; border:1px solid var(--glass-brd);
      background: linear-gradient(45deg, rgba(147,51,234,.18), rgba(147,51,234,.08)); color:#fff; transition:.2s;
    }
    .btn-primary{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; box-shadow:0 6px 22px rgba(139,92,246,.32);
    }
    .btn:hover{ transform: translateY(-1px); }

    /* ===== Game Screen ===== */
    .game-screen{ display:none; }
    .game-header{
      display:flex; justify-content:center; align-items:center; margin-bottom:18px; padding:12px 0;
    }
    .game-title{ 
      font-size:24px; font-weight:800; display:flex; gap:10px; align-items:center; 
      text-align:center; margin:0 auto 16px auto;
    }
    .game-controls{ display:flex; gap:10px; }
    .game-btn{
      background: rgba(147,51,234,.16); border:1px solid var(--glass-brd);
      color:var(--violet-200); padding:10px 14px; border-radius:12px; cursor:pointer;
      font-size:14px; font-weight:800; display:flex; gap:8px; align-items:center; transition:.2s;
    }
    .game-btn:hover{ background: rgba(147,51,234,.24); transform: scale(1.04); }

    .progress-container{ margin:5px 0 5px; }
    .progress-label{ display:flex; justify-content:space-between; align-items:center; color:var(--violet-200); font-weight:800; font-size:13px; margin-bottom:5px; }
    .progress-bar{ height:8px; border:1px solid var(--glass-brd); border-radius:10px; background: rgba(147,51,234,.16); overflow:hidden; }
    .progress-fill{ height:100%; width:0%; background: linear-gradient(90deg, #8b5cf6, #a855f7); transition: width .35s ease; box-shadow:0 0 12px rgba(168,85,247,.45); border-radius:10px; }

    .back-btn{
      background: rgba(147,51,234,.2); border:1px solid var(--glass-brd); color:var(--violet-200);
      padding:10px 14px; border-radius:12px; cursor:pointer; margin-bottom:5px; font-weight:800; display:inline-flex; gap:8px; align-items:center; transition:.2s;
    }
    .back-btn:hover{ transform: scale(1.03); background: rgba(147,51,234,.28); }

    /* New structure for headers and content */
    .game-content-wrapper {
      margin-top: 10px;
    }
    .game-columns-headers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .column-header{
      text-align:center; font-size:16px; font-weight:800; padding:12px;
      background: linear-gradient(45deg, rgba(147,51,234,.28), rgba(168,85,247,.18));
      border-radius:12px; border:1px solid var(--glass-brd-strong);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    
    .game-columns {
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .column{ display:flex; flex-direction:column; gap:10px; }
    
    .word-card{
      background: linear-gradient(135deg, rgba(147,51,234,.12), rgba(168,85,247,.06));
      border:2px solid var(--glass-brd);
      border-radius:12px; padding:18px; text-align:center; cursor:pointer; font-size:17px; font-weight:800;
      transition:.2s ease; min-height:72px; display:flex; align-items:center; justify-content:center; color:#fff; backdrop-filter: blur(6px);
      user-select:none;
    }
    .word-card:hover{ background: var(--glass-hover); transform: scale(1.02); box-shadow:0 6px 22px rgba(147,51,234,.22); }
    .word-card.selected{ border-color:#a855f7; background: linear-gradient(135deg, rgba(168,85,247,.32), rgba(147,51,234,.20)); box-shadow:0 0 20px rgba(168,85,247,.38); transform: scale(1.04); }
    .word-card.matched{ border-color: var(--green); background: linear-gradient(135deg, rgba(34,197,94,.28), rgba(34,197,94,.18)); color: var(--green); opacity:.82; cursor:default; }
    
    /* ===== NEW: Wrong Match Animation ===== */
    .word-card.wrong{ 
      border-color: var(--red) !important; 
      background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.25)) !important; 
      color: #fff !important;
      animation: shake-wrong 0.6s ease-in-out;
      box-shadow: 0 0 30px rgba(239,68,68,.6) !important;
    }

    @keyframes shake-wrong {
      0%, 100% { transform: translateX(0) scale(1.04); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) scale(1.04); }
      20%, 40%, 60%, 80% { transform: translateX(8px) scale(1.04); }
    }

    .game-complete{
      text-align:center; padding:20px; margin-top:24px;
      background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(34,197,94,.08));
      border:2px solid rgba(34,197,94,.3); border-radius:20px; backdrop-filter: blur(10px);
    }
    .game-complete img{
      width:120px; height:120px; border-radius:50%; margin-bottom:16px;
      border:4px solid rgba(34,197,94,.4); box-shadow:0 8px 32px rgba(34,197,94,.3);
    }
    .game-complete .message{
      font-size:18px; color:#fff; margin-bottom:5px; line-height:1.5;
    }
    .creator-name{
      font-size:28px; font-weight:900; margin-bottom:20px;
      background: linear-gradient(45deg, #22c55e, #10b981, #06d6a0, #22c55e);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: glow-pulse 2s ease-in-out infinite;
      text-shadow: 0 0 20px rgba(34,197,94,.5);
      filter: drop-shadow(0 0 10px rgba(34,197,94,.6));
    }
    @keyframes glow-pulse {
      0%, 100% { 
        background-position: 0% 50%;
        filter: drop-shadow(0 0 10px rgba(34,197,94,.6)) brightness(1);
      }
      50% { 
        background-position: 100% 50%;
        filter: drop-shadow(0 0 20px rgba(34,197,94,.9)) brightness(1.2);
      }
    }
    .play-again-btn{
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border:none; color:#fff;
      padding:12px 20px; border-radius:12px; font-weight:800; cursor:pointer; transition:.2s ease;
      font-size:16px; display:inline-flex; gap:8px; align-items:center;
      box-shadow:0 8px 25px rgba(34,197,94,.4);
    }
    .play-again-btn:hover{ transform: translateY(-2px); box-shadow:0 12px 35px rgba(34,197,94,.5); }

    /* New Answer View Styles */
    .answer-view {
      display: none;
      flex-direction: column;
      gap: 5px; /* Reduced gap between pairs */
    }
    .paired-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 5px; /* Reduced gap between rows */
    }

    @media(max-width:768px){
      .app-container{ padding:10px; }
      .game-columns{ gap:10px; }
      .word-card{ font-size:16px; min-height:60px; }
      .set-actions{ right:12px; }
      .action-btn{ width:38px; height:38px; }
      .game-btn{ padding:6px 8px; font-size:11px; gap:4px; }
      .back-btn{ padding:6px 8px; font-size:11px; gap:4px; }
      .game-controls{ gap:6px; }
      
      /* Mobile shake animation - less aggressive */
      @keyframes shake-wrong {
        0%, 100% { transform: translateX(0) scale(1.02); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px) scale(1.02); }
        20%, 40%, 60%, 80% { transform: translateX(5px) scale(1.02); }
      }
    }

    /* toast */
    .toast{
      position:fixed; right:18px; top:18px; z-index:1100; padding:12px 14px;
      background: rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.18); border-radius:12px; color:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; transform: translateY(-8px); transition:.25s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-menu" id="mainMenu">
      <div class="header">
        <h6 class="app-title"><i class="fas fa-language"></i> Word Pair Master</h6>
        <div class="sets-info" id="setsCount"><i class="fas fa-book"></i> 0 Sets</div>
      </div>

      <div id="setsList"></div>

      <div class="empty-state" id="emptyState" style="display:none;">
        <i class="fas fa-box-open"></i>
        Click the + button to create your first set.
      </div>

      <button class="add-btn" id="mainAddBtn" title="Create Set"><i class="fas fa-plus"></i></button>
    </div>

    <div class="game-screen" id="gameScreen">
      <h2 class="game-title" id="gameTitle"><i class="fas fa-gamepad"></i> Game</h2>
      
      <div class="game-header">
        <div class="game-controls">
          <button class="game-btn" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
          <button class="game-btn" id="soundBtn"><i class="fas fa-volume-up"></i> Sound</button>
          <button class="game-btn" id="speechBtn"><i class="fas fa-microphone"></i> Speech</button>
          <button class="game-btn" id="shuffleBtn"><i class="fas fa-random"></i> Shuffle</button>
          <button class="game-btn" id="answerBtn"><i class="fas fa-eye"></i> Answer</button>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-label">
          <span>Progress</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      
      <div class="game-content-wrapper">
        <div class="game-columns-headers">
          <div class="column-header"><i class="fas fa-language"></i> English </div>
          <div class="column-header"><i class="fas fa-globe"></i> Others </div>
        </div>

        <div class="game-columns" id="game-columns">
          <div class="column" id="leftCol"></div>
          <div class="column" id="rightCol"></div>
        </div>

        <div class="answer-view" id="answer-view"></div>
      </div>

      <div id="gameComplete" class="game-complete" style="display:none;">
        <a href="https://ibb.co.com/V0fzGC0c"><img src="https://i.ibb.co.com/XfcKP5fr/Shafiullah-AI-avatar.png" alt="Shafiullah-AI-avatar" border="0"></a>
        <div class="message">Congratulations! You got everything correct. Here's a big thanks from<div class="creator-name">Shafiullah! <h1><i class="fas fa-trophy"></i> </div>
        <button class="play-again-btn" id="playAgainBtn"><i class="fas fa-play"></i> Play Again</button>
      </div>
    </div>
  </div>

  <div class="modal" id="setModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="setModalTitle"><i class="fas fa-layer-group"></i> Create Set</div>
        <button class="close-btn" id="closeSetModalBtn" title="Close"><i class="fas fa-times"></i></button>
      </div>

      <div class="form-section">
        <div class="section-title"><i class="fas fa-pen"></i> Details</div>
        <div class="form-group">
          <label class="form-label" for="setNameInput">Set Name</label>
          <input id="setNameInput" class="form-input" placeholder="e.g., Basic Japanese" />
        </div>
        <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label class="form-label" for="categorySelect">Category</label>
            <select id="categorySelect" class="form-select">
              <option>General</option>
           </select>
          </div>
          <div>
            <label class="form-label" for="difficultySelect">Difficulty</label>
            <select id="difficultySelect" class="form-select">
              <option>Beginner</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="pairs-header">
          <div class="section-title"><i class="fas fa-link"></i> Word Pairs</div>
        </div>
        <div id="pairsContainer"></div>
        <button class="add-pair-btn" id="addPairBtn"><i class="fas fa-plus"></i> Add Pair</button>
      </div>

      <div class="form-actions">
        <button class="btn" id="cancelSetBtn"><i class="fas fa-ban"></i> Cancel</button>
        <button class="btn btn-primary" id="saveSetBtn"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ====================== State ======================
    const LS_KEY = "wordPairMasterSets";
    let sets = [];
    let editingIndex = -1;

    // game state
    let currentSetIndex = -1;
    let firstSelection = null; // {el, pairId, lang}
    let secondSelection = null;
    let lockBoard = false;
    let pairsFound = 0;
    let matchedPairIds = new Set();
    let soundOn = true;
    let speechOn = true;
    let answersVisible = false;

    // ====================== Elements ======================
    const mainMenu = document.getElementById("mainMenu");
    const setsList = document.getElementById("setsList");
    const setsCount = document.getElementById("setsCount");
    const emptyState = document.getElementById("emptyState");
    const mainAddBtn = document.getElementById("mainAddBtn");

    const gameScreen = document.getElementById("gameScreen");
    const gameTitle = document.getElementById("gameTitle");
    const backBtn = document.getElementById("backBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const soundBtn = document.getElementById("soundBtn");
    const speechBtn = document.getElementById("speechBtn");
    const answerBtn = document.getElementById("answerBtn");
    const gameColumns = document.getElementById("game-columns"); // Now this only contains the word cards
    const leftCol = document.getElementById("leftCol");
    const rightCol = document.getElementById("rightCol");
    const answerView = document.getElementById("answer-view");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const gameComplete = document.getElementById("gameComplete");
    const playAgainBtn = document.getElementById("playAgainBtn");

    const setModal = document.getElementById("setModal");
    const setModalTitle = document.getElementById("setModalTitle");
    const closeSetModalBtn = document.getElementById("closeSetModalBtn");
    const setNameInput = document.getElementById("setNameInput");
    const categorySelect = document.getElementById("categorySelect");
    const difficultySelect = document.getElementById("difficultySelect");
    const pairsContainer = document.getElementById("pairsContainer");
    const addPairBtn = document.getElementById("addPairBtn");
    const cancelSetBtn = document.getElementById("cancelSetBtn");
    const saveSetBtn = document.getElementById("saveSetBtn");

    const toastEl = document.getElementById("toast");

    // ====================== Utils ======================
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 1600);
    }
    function loadSets(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        sets = raw ? JSON.parse(raw) : [];
      }catch(e){
        console.warn("Failed to load sets", e);
        sets = [];
      }
    }
    function saveSets(){
      localStorage.setItem(LS_KEY, JSON.stringify(sets));
    }
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function openModal(){ setModal.classList.add("show"); setModal.setAttribute("aria-hidden","false"); }
    function closeModal(){ setModal.classList.remove("show"); setModal.setAttribute("aria-hidden","true"); }

    // ====================== NEW: Vibration Function ======================
    function triggerVibration(){
      // Check if vibration API is supported
      if ('vibrate' in navigator) {
        // Vibrate pattern: [vibrate, pause, vibrate, pause, ...]
        // This creates a strong vibration pattern for wrong matches
        navigator.vibrate([100, 50, 100, 50, 150]);
      }
    }

    // ====================== Sets UI ======================
    function renderSets(){
      setsList.innerHTML = "";
      if(sets.length === 0){
        emptyState.style.display = "block";
      }else{
        emptyState.style.display = "none";
        sets.forEach((set, index)=>{
          const card = document.createElement("div");
          card.className = "set-card";
          card.innerHTML = `
            <div class="set-name"><i class="fas fa-layer-group"></i> ${escapeHtml(set.name)}</div>
            <div class="set-info">
              <div class="set-info-item"><i class="fas fa-link"></i> ${set.pairs.length} pairs</div>
              <div class="set-info-item"><i class="fas fa-tag"></i> ${escapeHtml(set.category || "General")}</div>
              <div class="set-info-item"><i class="fas fa-signal"></i> ${escapeHtml(set.difficulty || "Beginner")}</div>
            </div>
            <div class="set-actions">
              <button class="action-btn play-btn" title="Play" data-action="play" data-index="${index}">
                <i class="fas fa-play"></i>
              </button>
              <button class="action-btn edit-btn" title="Edit" data-action="edit" data-index="${index}">
                <i class="fas fa-pen"></i>
              </button>
              <button class="action-btn delete-btn" title="Delete" data-action="delete" data-index="${index}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          // clicking anywhere on card also starts game
          card.addEventListener("click",(e)=>{
            const actBtn = e.target.closest(".action-btn");
            if(actBtn) return; // handled below
            startGame(index);
          });
          // actions
          card.querySelectorAll(".action-btn").forEach(btn=>{
            btn.addEventListener("click",(e)=>{
              e.stopPropagation();
              const idx = +btn.dataset.index;
              const action = btn.dataset.action;
              if(action === "play") startGame(idx);
              else if(action === "edit") openEditSet(idx);
              else if(action === "delete") { deleteSet(idx); }
            });
          });

          setsList.appendChild(card);
        });
      }
      setsCount.innerHTML = `<i class="fas fa-book"></i> ${sets.length} Set${sets.length!==1?"s":""}`;
    }

    function deleteSet(index){
      if(!confirm("Delete this set?")) return;
      sets.splice(index,1);
      saveSets();
      renderSets();
      showToast("Set deleted");
    }

    // ====================== Create / Edit Modal ======================
    function openCreateSet(){
      editingIndex = -1;
      setModalTitle.innerHTML = `<i class="fas fa-layer-group"></i> Create Set`;
      setNameInput.value = "";
      categorySelect.value = "General";
      difficultySelect.value = "Beginner";
      pairsContainer.innerHTML = "";
      addPairRow();
      openModal();
    }

    function openEditSet(index){
      editingIndex = index;
      const set = sets[index];
      setModalTitle.innerHTML = `<i class="fas fa-pen"></i> Edit Set`;
      setNameInput.value = set.name || "";
      categorySelect.value = set.category || "General";
      difficultySelect.value = set.difficulty || "Beginner";
      pairsContainer.innerHTML = "";
      (set.pairs || []).forEach(p => addPairRow(p.word1, p.word2));
      if((set.pairs || []).length === 0) addPairRow();
      openModal();
    }

    function addPairRow(w1="", w2=""){
      const row = document.createElement("div");
      row.className = "pair-row";
      row.innerHTML = `
        <input class="form-input" placeholder="English" value="${escapeAttr(w1)}" />
        <input class="form-input" placeholder="Other language" value="${escapeAttr(w2)}" />
        <button class="remove-pair-btn" title="Remove"><i class="fas fa-times"></i></button>
      `;
      row.querySelector(".remove-pair-btn").addEventListener("click", ()=> {
        row.remove();
      });
      pairsContainer.appendChild(row);
    }

    function gatherPairs(){
      const rows = Array.from(pairsContainer.querySelectorAll(".pair-row"));
      const pairs = rows.map(r=>{
        const [i1, i2] = r.querySelectorAll("input");
        return { word1: (i1.value||"").trim(), word2: (i2.value||"").trim() };
      }).filter(p=> p.word1 && p.word2);
      return pairs;
    }

    function saveSet(){
      const name = setNameInput.value.trim();
      const category = categorySelect.value;
      const difficulty = difficultySelect.value;
      const pairs = gatherPairs();

      if(!name || pairs.length===0){
        showToast("Please enter a set name and at least one valid pair.");
        return;
      }

      if(editingIndex === -1){
        sets.push({ name, category, difficulty, pairs });
        showToast("Set created");
      }else{
        sets[editingIndex] = { name, category, difficulty, pairs };
        showToast("Set updated");
      }
      saveSets();
      renderSets();
      closeModal();
    }

    // ====================== Game Logic ======================
    function startGame(index){
      currentSetIndex = index;
      const set = sets[index];
      if(!set || !set.pairs || set.pairs.length===0){
        showToast("This set has no pairs.");
        return;
      }
      // reset state
      firstSelection = null;
      secondSelection = null;
      lockBoard = false;
      matchedPairIds = new Set();
      pairsFound = 0;
      answersVisible = false;

      // UI
      mainMenu.style.display = "none";
      gameScreen.style.display = "block";
      gameTitle.innerHTML = `<i class="fas fa-gamepad"></i> ${escapeHtml(set.name)}`;
      gameComplete.style.display = "none";
      answerBtn.innerHTML = `<i class="fas fa-eye"></i> Answer`;
      
      // Initial render: show game columns, hide answer view
      gameColumns.style.display = "grid";
      answerView.style.display = "none";
      
      renderGameColumns();
      updateProgress();
    }

    function renderGameColumns(){
      const set = sets[currentSetIndex];
      const englishWords = set.pairs.map((pair, i)=> ({ text: pair.word1, pairId: i, lang: "en" }));
      const otherWords   = set.pairs.map((pair, i)=> ({ text: pair.word2, pairId: i, lang: "other" }));

      shuffleArray(englishWords);
      shuffleArray(otherWords);

      leftCol.innerHTML = "";
      rightCol.innerHTML = "";

      englishWords.forEach(data=> leftCol.appendChild(createWordCard(data)));
      otherWords.forEach(data=> rightCol.appendChild(createWordCard(data)));
    }

    function createWordCard({text, pairId, lang}){
      const div = document.createElement("div");
      div.className = "word-card";
      div.textContent = text;
      div.dataset.pairId = String(pairId);
      div.dataset.lang = lang;
      
      if(matchedPairIds.has(String(pairId))){
        // mark matched tiles (for reshuffle)
        div.classList.add("matched");
        div.style.pointerEvents = "none";
      }else{
        div.addEventListener("click", handleCardClick);
      }
      return div;
    }

    function handleCardClick(e){
      if(lockBoard || answersVisible) return;
      const el = e.currentTarget;
      if(el.classList.contains("matched")) return;

      // Speak word when clicked (if speech is on)
      if(speechOn){
        speakText(el.textContent, el.dataset.lang);
      }

      // select
      if(firstSelection && el === firstSelection.el) return; // click same
      el.classList.add("selected");

      if(!firstSelection){
        firstSelection = {
          el,
          pairId: el.dataset.pairId,
          lang: el.dataset.lang
        };
        playClick();
      }else{
        secondSelection = {
          el,
          pairId: el.dataset.pairId,
          lang: el.dataset.lang
        };

        // must be from different columns/langs
        if(firstSelection.lang === secondSelection.lang){
          // replace selection: keep latest as first
          firstSelection.el.classList.remove("selected");
          firstSelection = { ...secondSelection };
          secondSelection = null;
          playClick();
          return;
        }

        // evaluate
        lockBoard = true;
        if(firstSelection.pairId === secondSelection.pairId){
          // match
          setTimeout(()=>{
            firstSelection.el.classList.remove("selected");
            secondSelection.el.classList.remove("selected");
            firstSelection.el.classList.add("matched");
            secondSelection.el.classList.add("matched");
            firstSelection.el.style.pointerEvents = "none";
            secondSelection.el.style.pointerEvents = "none";

            matchedPairIds.add(firstSelection.pairId);
            pairsFound++;
            playSuccess();

            resetPick();
            lockBoard = false;
            updateProgress();
            checkCompletion();
          }, 220);
        }else{
          // ====================== ENHANCED: Wrong Match with Effects ======================
          playError();
          triggerVibration(); // NEW: Add vibration
          
          firstSelection.el.classList.add("wrong");
          secondSelection.el.classList.add("wrong");
          
          setTimeout(()=>{
            firstSelection.el.classList.remove("selected","wrong");
            secondSelection.el.classList.remove("selected","wrong");
            resetPick();
            lockBoard = false;
          }, 650);
        }
      }
    }

    function resetPick(){
      firstSelection = null;
      secondSelection = null;
    }

    function updateProgress(){
      const total = sets[currentSetIndex].pairs.length;
      const pct = Math.round((pairsFound/total)*100);
      progressFill.style.width = pct + "%";
      progressText.textContent = pct + "%";
    }

    function checkCompletion(){
      const total = sets[currentSetIndex].pairs.length;
      if(pairsFound >= total){
        setTimeout(() => {
          gameComplete.style.display = "block";
        }, 500);
      }
    }

    function backToMenu(){
      gameScreen.style.display = "none";
      mainMenu.style.display = "block";
      renderSets();
    }

    function reshuffleGame(){
      if(answersVisible) {
        hideAnswers();
      }
      if(sets[currentSetIndex]?.pairs?.length){
        const total = sets[currentSetIndex].pairs.length;
        const isGameComplete = pairsFound >= total;
        
        // Reset game state
        firstSelection = null;
        secondSelection = null;
        lockBoard = false;
        
        // If game is complete, reset everything to start over
        if(isGameComplete) {
          matchedPairIds = new Set();
          pairsFound = 0;
          updateProgress();
          gameComplete.style.display = "none";
          showToast("Game restarted!");
        } else {
          showToast("Shuffled");
        }
        
        // Re-render the game columns
        renderGameColumns();
      }
    }
    
    // ====================== NEW: Answer Toggle Logic ======================
    function toggleAnswers() {
      if (answersVisible) {
        hideAnswers();
      } else {
        showAnswers();
      }
    }

    function showAnswers() {
      if(lockBoard) return;
      answersVisible = true;
      
      showToast("Answers revealed");
      
      // Hide the game cards container
      gameColumns.style.display = "none";

      // Show the answer view
      answerView.style.display = "flex";
      
      answerBtn.innerHTML = `<i class="fas fa-eye-slash"></i> Hide`;
      
      // Hide any selected card
      if (firstSelection) {
        firstSelection.el.classList.remove("selected");
        resetPick();
      }

      renderAnswerPairs();
    }
    
    function hideAnswers() {
      answersVisible = false;
      
      showToast("Answers hidden");
      
      // Hide the answer view
      answerView.style.display = "none";
      
      // Show the game cards container again
      gameColumns.style.display = "grid";
      
      answerBtn.innerHTML = `<i class="fas fa-eye"></i> Answer`;
      
      // Reshuffle the game cards
      renderGameColumns();
    }
    
    function renderAnswerPairs() {
      answerView.innerHTML = ""; // Clear existing content
      const set = sets[currentSetIndex];
      set.pairs.forEach(pair => {
          const row = document.createElement("div");
          row.className = "paired-row";
          
          // Create and append English card
          const englishCard = createWordCard({
            text: pair.word1,
            pairId: -1, // No pair ID needed for this view
            lang: "en"
          });
          englishCard.classList.add("matched");
          englishCard.style.pointerEvents = "none";
          
          // Create and append other language card
          const otherCard = createWordCard({
            text: pair.word2,
            pairId: -1,
            lang: "other"
          });
          otherCard.classList.add("matched");
          otherCard.style.pointerEvents = "none";
          
          row.appendChild(englishCard);
          row.appendChild(otherCard);
          answerView.appendChild(row);
      });
    }

    // ====================== Text-to-Speech ======================
    function speakText(text, lang) {
      if (!speechOn || !window.speechSynthesis) return;
      
      // Cancel any ongoing speech
      window.speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      
      // Set voice based on language
      if (lang === "other") {
        // Try to use Japanese voice
        utterance.lang = "ja-JP";
        utterance.rate = 0.8;
      } else {
        // Use English voice
        utterance.lang = "en-US";
        utterance.rate = 0.9;
      }
      
      utterance.volume = 0.7;
      utterance.pitch = 1.0;
      
      // Try to find specific voice
      const voices = window.speechSynthesis.getVoices();
      if (lang === "other") {
        const japaneseVoice = voices.find(voice => 
          voice.lang.startsWith('ja') || voice.name.includes('Japanese')
        );
        if (japaneseVoice) {
          utterance.voice = japaneseVoice;
        }
      } else {
        const englishVoice = voices.find(voice => 
          voice.lang.startsWith('en') && voice.default
        );
        if (englishVoice) {
          utterance.voice = englishVoice;
        }
      }
      
      window.speechSynthesis.speak(utterance);
    }

    // Load voices when available
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {
        // Voices are now loaded
      };
    }

    // ====================== Sound Effects ======================
    function playTone(freq=880, ms=120, type="sine", gain=0.05){
      if(!soundOn) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        g.gain.value = gain;
        osc.connect(g); g.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
      }catch(_){}
    }
    function playSuccess(){ playTone(980, 120, "triangle", 0.06); }
    function playError(){ playTone(220, 160, "sawtooth", 0.06); }
    function playClick(){ playTone(660, 80, "square", 0.04); }

    // ====================== Events ======================
    mainAddBtn.addEventListener("click", openCreateSet);
    closeSetModalBtn.addEventListener("click", closeModal);
    cancelSetBtn.addEventListener("click", closeModal);
    addPairBtn.addEventListener("click", ()=> addPairRow());
    saveSetBtn.addEventListener("click", saveSet);

    backBtn.addEventListener("click", backToMenu);
    shuffleBtn.addEventListener("click", reshuffleGame);
    soundBtn.addEventListener("click", ()=>{
      soundOn = !soundOn;
      soundBtn.innerHTML = soundOn
        ? `<i class="fas fa-volume-up"></i> Sound`
        : `<i class="fas fa-volume-xmark"></i> Sound Off`;
      showToast(soundOn ? "Game sounds on" : "Game sounds off");
    });
    
    speechBtn.addEventListener("click", ()=>{
      speechOn = !speechOn;
      speechBtn.innerHTML = speechOn
        ? `<i class="fas fa-microphone"></i> Speech`
        : `<i class="fas fa-microphone-slash"></i> Speech Off`;
      showToast(speechOn ? "Text-to-speech on" : "Text-to-speech off");
    });

    answerBtn.addEventListener("click", toggleAnswers);

    playAgainBtn.addEventListener("click", ()=>{
      // Reset game state
      matchedPairIds = new Set();
      pairsFound = 0;
      firstSelection = null;
      secondSelection = null;
      lockBoard = false;
      
      // Hide completion screen and restart
      gameComplete.style.display = "none";
      updateProgress();
      renderGameColumns();
      showToast("Let's play again!");
    });

    // ====================== Helpers ======================
    function escapeHtml(str=""){
      return str.replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
    }
    function escapeAttr(str=""){ return escapeHtml(str).replace(/"/g, "&quot;"); }

    // ====================== Init ======================
    (function init(){
      loadSets();
      renderSets();
    })();
  </script>
</body>
</html>
